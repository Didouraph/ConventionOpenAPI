openapi: 3.1.0
info:
  title: review-api
  description: |
    API pour la gestion des évaluations (reviews) des films du système VOD.
    Les évaluations sont stockées dans MongoDB.
  
  version: 1.0.0

servers:
  - url: http://localhost:8082/api/v1
    description: Serveur de développement

paths:
  /movies/{movieId}/reviews:
    get:
      summary: Liste toutes les évaluations d'un film
      description: Renvoie toutes les évaluations associées à un film (accessible sans authentification).
      parameters:
        - name: movieId
          in: path
          required: true
          description: Identifiant du film.
          schema:
            type: integer
      responses:
        '200':
          description: Liste des évaluations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Review'
        '404':
          description: Film non trouvé (optionnel selon l'implémentation)

    post:
      summary: Ajouter une évaluation à un film
      description: |
        Ajoute une évaluation (note entière 0..5 + commentaire optionnel).
        Règle métier : l'utilisateur doit être connecté et avoir réservé le film (en cours ou passé).
      security:
        - bearerAuth: []
      parameters:
        - name: movieId
          in: path
          required: true
          description: Identifiant du film.
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewCreate'
      responses:
        '201':
          description: Évaluation créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Requête invalide (note hors intervalle, body manquant, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit (l'utilisateur n'a jamais réservé ce film)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Film non trouvé

  /movies/{movieId}/reviews/{reviewId}:
    get:
      summary: Récupérer une évaluation par son identifiant
      description: Renvoie une évaluation spécifique associée à un film (accessible sans authentification).
      parameters:
        - name: movieId
          in: path
          required: true
          description: Identifiant du film.
          schema:
            type: integer
        - name: reviewId
          in: path
          required: true
          description: Identifiant MongoDB de l'évaluation.
          schema:
            type: string
      responses:
        '200':
          description: Évaluation trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '404':
          description: Évaluation non trouvée

    put:
      summary: Mettre à jour une évaluation
      description: |
        Met à jour une évaluation existante.
        Règle proposée : seul l'auteur de l'évaluation (ou un admin) peut modifier.
      security:
        - bearerAuth: []
      parameters:
        - name: movieId
          in: path
          required: true
          schema:
            type: integer
        - name: reviewId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewUpdate'
      responses:
        '200':
          description: Évaluation mise à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Requête invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit (review appartenant à un autre utilisateur)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Évaluation non trouvée

    delete:
      summary: Supprimer une évaluation
      description: |
        Supprime une évaluation.
        Règle proposée : seul l'auteur (ou un admin) peut supprimer.
      security:
        - bearerAuth: []
      parameters:
        - name: movieId
          in: path
          required: true
          schema:
            type: integer
        - name: reviewId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Évaluation supprimée avec succès
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Accès interdit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Évaluation non trouvée

  /movies/{movieId}/reviews/average:
    get:
      summary: Récupérer la moyenne des évaluations d'un film
      description: |
        Renvoie la moyenne des notes et le nombre total d'évaluations associées à un film.
        Accessible sans authentification.
      parameters:
        - name: movieId
          in: path
          required: true
          description: Identifiant du film.
          schema:
            type: integer
      responses:
        '200':
          description: Moyenne des évaluations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewAverage'
        '404':
          description: Film non trouvé (optionnel selon l'implémentation)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ReviewCreate:
      type: object
      required:
        - rating
      properties:
        rating:
          type: integer
          minimum: 0
          maximum: 5
          description: Note entière entre 0 et 5.
        comment:
          type: string
          description: Commentaire optionnel.

    ReviewUpdate:
      type: object
      description: |
        Données modifiables d'une évaluation.
        (On ne permet pas de modifier movieId ni l'auteur.)
      properties:
        rating:
          type: integer
          minimum: 0
          maximum: 5
        comment:
          type: string

    Review:
      type: object
      required:
        - id
        - movieId
        - username
        - rating
        - createdAt
      properties:
        id:
          type: string
          description: Identifiant MongoDB de l'évaluation.
        movieId:
          type: integer
          description: Identifiant du film.
        username:
          type: string
          description: Pseudo de l'utilisateur ayant posté l'évaluation.
        rating:
          type: integer
          minimum: 0
          maximum: 5
        comment:
          type: string
        createdAt:
          type: string
          format: date-time
          description: Date de création de l'évaluation.
        updatedAt:
          type: string
          format: date-time
          description: Date de dernière mise à jour (optionnel).

    ReviewAverage:
      type: object
      required:
        - movieId
        - average
        - count
      properties:
        movieId:
          type: integer
        average:
          type: number
          format: double
          description: Moyenne des notes.
        count:
          type: integer
          minimum: 0
          description: Nombre total d'évaluations.

    ErrorResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: integer
          description: Code HTTP
          example: 400
        message:
          type: string
          example: "rating must be between 0 and 5"
        path:
          type: string
          example: "/api/v1/movies/423/reviews"
        timestamp:
          type: string
          format: date-time
